<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DoV COMMANDER v8.0 (FULL INTEGRAL)</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #050505; color: #ccc; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #111; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 4px; }
        .animate-fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Couleurs strictes du Fichier 30 */
        .text-dov-main { color: #00e676; }
        .text-dov-alert { color: #ff1744; }
        .text-dov-sec { color: #29b6f6; }
        .text-dov-warn { color: #ff9800; }
        .text-dov-dovx { color: #9c27b0; }
        .bg-dov-panel { background-color: #111; }
        
        .progress-bar-container { background: #222; height: 12px; border-radius: 3px; overflow: hidden; display: flex; }
        .bar-demand { background: #ff1744; height: 100%; transition: width 0.5s; }
        .bar-supply { background: #00e676; height: 100%; transition: width 0.5s; }
    </style>
</head>
<body>

    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        // --- 1. DATA LAYER (CONSTANTES GLOBALES) ---
        const RPCS = ["https://wax.greymass.com", "https://api.waxsweden.org", "https://wax.eosn.io", "https://api.wax.alohaeos.com", "https://api-wax.eosarabia.net"];
        
        // DonnÃ©es Statiques du Fichier 28 (Factories, Zones dÃ©taillÃ©es)
        const FACTORIES = [
            {id:'c_f1', name:'Common Fuel 1', type:'FUEL', rarity:'Common', level:1, output:5.4, cost:0.459},
            {id:'c_r1', name:'Common Repair 1', type:'REPAIR', rarity:'Common', level:1, output:5.4, cost:0.459},
            {id:'c_s1', name:'Common Supply 1', type:'SUPPLY', rarity:'Common', level:1, output:5.4, cost:0.459},
            {id:'c_h1', name:'Common Health 1', type:'HEALTH', rarity:'Common', level:1, output:5.4, cost:0.459},
            // ... (Version abrÃ©gÃ©e pour la dÃ©mo, la logique s'applique Ã  tout)
            {id:'r_f1', name:'Rare Fuel 1', type:'FUEL', rarity:'Rare', level:1, output:16.2, cost:1.37},
            {id:'e_f1', name:'Epic Fuel 1', type:'FUEL', rarity:'Epic', level:1, output:48.6, cost:4.13},
            {id:'l_f1', name:'Legendary Fuel 1', type:'FUEL', rarity:'Legendary', level:1, output:145.8, cost:12.39},
            {id:'s_f1', name:'Supreme Fuel 1', type:'FUEL', rarity:'Supreme', level:1, output:2255.3, cost:191.7}
        ];

        const ZONES_DB = {
            1: { name: "Beach 1", cost: 1160, costX: 0, reward: 400 }, 
            2: { name: "Beach 2", cost: 6968, costX: 0, reward: 2405 },
            3: { name: "Beach 3", cost: 8800, costX: 0, reward: 3037 },
            4: { name: "Bunker", cost: 11120, costX: 0, reward: 3838 },
            5: { name: "Forest 1", cost: 14024, costX: 0, reward: 4839 },
            8: { name: "Camp", cost: 28220, costX: 0, reward: 9617 },
            12: { name: "Radar", cost: 84712, costX: 0, reward: 28427 },
            16: { name: "HQ", cost: 188000, costX: 0, reward: 64884 },
            17: { name: "City 1", cost: 0, costX: 1664, reward: 0 },
            20: { name: "Bridge", cost: 0, costX: 29120, reward: 0 }
        };

        // --- 2. COMPOSANTS UI ---
        const Card = ({children, className=""}) => <div className={`bg-dov-panel border border-gray-800 p-4 ${className}`}>{children}</div>;
        const Icon = ({d, c}) => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className={c}><path d={d}/></svg>;

        // ==========================================
        // 3. MODULE SCANNER (MOTEUR)
        // ==========================================
        const ScannerEngine = ({ user, onUpdate }) => {
            const [scanning, setScanning] = useState(false);
            const [logs, setLogs] = useState([]);

            const log = (msg) => setLogs(p => [`> ${msg}`, ...p].slice(0,3));

            const fetchTable = async (code, table, lower) => {
                let attempts = 0;
                while(attempts < 3) {
                    try {
                        const rpc = RPCS[Math.floor(Math.random()*RPCS.length)];
                        const res = await fetch(`${rpc}/v1/chain/get_table_rows`, {
                            method: 'POST', body: JSON.stringify({json:true, code, scope:code, table, limit:1000, lower_bound:lower})
                        });
                        if(res.ok) return await res.json();
                    } catch(e) {}
                    attempts++;
                }
                return {rows:[]};
            };

            const start = async () => {
                setScanning(true); log("Scan dÃ©marrÃ©...");
                let builds = [], divs = [], next = "", more = true;
                
                // Buildings
                try {
                    while(more) {
                        const d = await fetchTable("dovutilstake", "buildings", next);
                        if(!d.rows?.length) break;
                        const batch = d.rows.filter(r => r.owner === user);
                        builds.push(...batch);
                        if(d.more && d.next_key !== next) next = d.next_key; else more = false;
                        log(`TrouvÃ© ${builds.length} BÃ¢timents...`);
                    }
                } catch(e) { log("Err BÃ¢timents"); }

                // Divisions
                try {
                    const d = await fetchTable("dovpvecontrl", "sdivisions", user);
                    if(d.rows) divs = d.rows.filter(r => r.owner === user || r.user === user);
                    log(`TrouvÃ© ${divs.length} Divisions.`);
                } catch(e) { log("Err Divisions"); }

                onUpdate(builds, divs);
                setScanning(false);
                log("Scan TerminÃ©.");
            };

            return (
                <div className="flex justify-between items-center bg-gray-900 p-2 border-b border-gray-800">
                    <div className="flex items-center gap-4">
                        <span className="text-dov-main font-bold text-sm">STATUS: {scanning ? 'SCAN...' : 'PRÃŠT'}</span>
                        <span className="text-xs text-gray-500 font-mono">{logs[0]}</span>
                    </div>
                    <button onClick={start} disabled={scanning} className="bg-dov-dovx text-white px-4 py-1 text-xs font-bold uppercase rounded hover:opacity-80">
                        {scanning ? '...' : 'SCAN'}
                    </button>
                </div>
            );
        };

        // ==========================================
        // 4. VUE DASHBOARD (REPLIQUE EXACTE FICHIER 30)
        // ==========================================
        const DashboardView = ({ buildings, divisions, prices }) => {
            const stats = useMemo(() => {
                let demand = { F:0, H:0, R:0, S:0, DOVX:0 };
                let supply = { F:0, H:0, R:0, S:0 };
                let mint = 0;

                // Demand (Divisions Actives)
                divisions.forEach(d => {
                    if(d.end_time > Date.now()/1000) {
                        const z = ZONES_DB[d.zone_id];
                        if(z) {
                            if(z.costX > 0) demand.DOVX += z.costX;
                            else {
                                const costPerRes = z.cost / 4;
                                demand.F += costPerRes; demand.H += costPerRes; demand.R += costPerRes; demand.S += costPerRes;
                            }
                            if(z.reward > 0) mint += z.reward;
                        }
                    }
                });

                // Supply (BÃ¢timents)
                buildings.forEach(b => {
                    const val = parseFloat((Array.isArray(b.power)?b.power[0]:b.power).replace(/[^0-9.]/g,'')) || 0;
                    const type = (Array.isArray(b.power)?b.power[0]:b.power);
                    if(type.includes("DOVF")) supply.F += val;
                    if(type.includes("DOVH")) supply.H += val;
                    if(type.includes("DOVR")) supply.R += val;
                    if(type.includes("DOVS")) supply.S += val;
                    // CoÃ»t maintenance (approx 10% output en DOVX)
                    demand.DOVX += val * 0.1;
                });

                const totalDemandTU = demand.F + demand.H + demand.R + demand.S;
                const totalSupplyTU = supply.F + supply.H + supply.R + supply.S;
                const pctD = totalDemandTU + totalSupplyTU > 0 ? (totalDemandTU / (totalDemandTU + totalSupplyTU)) * 100 : 50;
                
                return { demand, supply, totalDemandTU, totalSupplyTU, pctD, mint, net: mint - demand.DOVX };
            }, [buildings, divisions]);

            const fmt = (n) => Math.floor(n).toLocaleString();
            const fmtUSD = (n) => `$${(n * prices.WAX_USD).toFixed(2)}`;

            return (
                <div className="space-y-4 p-4">
                    {/* TOP STATS */}
                    <div className="grid grid-cols-3 gap-4">
                        <Card className="border-t-2 border-red-500">
                            <div className="flex justify-between text-xs text-gray-500 mb-2"><span>DEMANDE (COMBATTANTS)</span><span>ðŸ”¥ BURN</span></div>
                            <div className="text-2xl font-bold text-white">{fmt(stats.totalDemandTU)} TU</div>
                            <div className="text-xs text-right text-dov-main">{fmtUSD(stats.totalDemandTU * prices.TU_WAX)} / 24h</div>
                        </Card>
                        <Card className="border-t-2 border-green-500">
                            <div className="flex justify-between text-xs text-gray-500 mb-2"><span>OFFRE (PRODUCTEURS)</span><span>âš¡ MINT</span></div>
                            <div className="text-2xl font-bold text-white">{fmt(stats.totalSupplyTU)} TU</div>
                            <div className="text-xs text-right text-dov-main">{fmtUSD(stats.totalSupplyTU * prices.TU_WAX)} / 24h</div>
                        </Card>
                        <Card className="border-t-2 border-purple-500">
                            <div className="flex justify-between text-xs text-gray-500 mb-2"><span>PRESSION DOVX</span><span>ðŸ“‰ INPUT</span></div>
                            <div className="text-2xl font-bold text-white">{fmt(stats.demand.DOVX)} DOVX</div>
                            <div className="text-xs text-right text-dov-main">{fmtUSD(stats.demand.DOVX * prices.DOVX_WAX)} / 24h</div>
                        </Card>
                    </div>

                    {/* BARRE BALANCE */}
                    <div className="bg-dov-panel p-4 border border-gray-800">
                        <div className="flex justify-between text-xs font-bold mb-2">
                            <span className="text-dov-alert">DEMANDE (BURN)</span>
                            <span className="text-white">RATIO</span>
                            <span className="text-dov-main">OFFRE (MINT)</span>
                        </div>
                        <div className="progress-bar-container">
                            <div className="bar-demand" style={{width: `${stats.pctD}%`}}></div>
                            <div className="bar-supply" style={{width: `${100 - stats.pctD}%`}}></div>
                        </div>
                    </div>

                    {/* MATRICE DETAILLEE */}
                    <div className="grid grid-cols-4 gap-2">
                        {['F', 'H', 'R', 'S'].map(t => {
                            const net = stats.supply[t] - stats.demand[t];
                            const col = t==='F'?'orange': t==='H'?'red': t==='R'?'gray': 'yellow';
                            return (
                                <div key={t} className={`bg-gray-900 border-t-2 p-2 border-${col}-500`}>
                                    <div className="text-center font-bold text-xs mb-2 text-white">TYPE {t}</div>
                                    <div className="flex justify-between text-xs text-gray-400"><span>Prod</span><span>{fmt(stats.supply[t])}</span></div>
                                    <div className="flex justify-between text-xs text-gray-400 mb-2"><span>Besoin</span><span>{fmt(stats.demand[t])}</span></div>
                                    <div className={`text-center text-sm font-bold border p-1 ${net>=0?'text-dov-main border-green-900':'text-dov-alert border-red-900'}`}>
                                        {net>=0?'+':''}{fmt(net)}
                                    </div>
                                </div>
                            )
                        })}
                    </div>

                    {/* BALANCE DOVX */}
                    <div className="bg-gray-900 border border-purple-500 p-4">
                        <div className="text-dov-dovx font-bold text-sm mb-4">BALANCE DOVX (MINT vs BURN)</div>
                        <div className="grid grid-cols-3 gap-4">
                            <div className="p-2 border border-green-500/50">
                                <div className="text-xs text-dov-main">GAINS COMBATS</div>
                                <div className="text-xl font-bold text-white">+{fmt(stats.mint)}</div>
                            </div>
                            <div className="p-2 border border-red-500/50">
                                <div className="text-xs text-dov-alert">COÃ›TS VILLES + USINES</div>
                                <div className="text-xl font-bold text-white">-{fmt(stats.demand.DOVX)}</div>
                            </div>
                            <div className="p-2 border border-white/20">
                                <div className="text-xs text-white">RÃ‰SULTAT NET</div>
                                <div className={`text-xl font-bold ${stats.net>0?'text-dov-main':'text-dov-alert'}`}>{fmt(stats.net)} DOVX</div>
                                <div className="text-xs text-right text-gray-500">{fmtUSD(stats.net * prices.DOVX_WAX)}</div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // ==========================================
        // 5. VUE BLEND SIMULATOR (INTEGRALE FICHIER 29)
        // ==========================================
        const BlendView = ({ prices, waxPrice }) => {
            const [activeZone, setActiveZone] = useState('CITY_1'); 
            const [inventory, setInventory] = useState({ FUEL: 0, REPAIR: 0, SUPPLY: 0, HEALTH: 0, F4_FUEL: 0, F4_REPAIR: 0, F4_SUPPLY: 0, F4_HEALTH: 0, KEY_CITY: 0, KEY_BEACH: 0, KEY_FOREST: 0 });
            const [simStats, setSimStats] = useState({ runs: 0 });
            
            // CONFIG PRICES (RestaurÃ© du fichier 29)
            const [keyPrices, setKeyPrices] = useState({ CITY: 50, BEACH: 5, FOREST: 10 });
            const [f1Price, setF1Price] = useState(5);
            const [f4Price, setF4Price] = useState(250);
            
            const ZONE_DATA = {
                CITY_1: { cost: 1664, currency: 'DOVX', packRatio: 1 },
                BUNKER: { cost: 44480, currency: 'TU', packRatio: 27 }, 
                CAMP: { cost: 112880, currency: 'TU', packRatio: 1 }
            };

            const currentData = ZONE_DATA[activeZone];
            const runCostWax = currentData.currency === 'TU' ? (currentData.cost * prices.TU_WAX) : (currentData.cost * prices.DOVX_WAX);

            const runSimulation = () => {
                let inv = { ...inventory };
                for(let i=0; i<100; i++) {
                    const r = Math.random();
                    // Drop Building
                    if (activeZone === 'CITY_1') {
                        if (r < 0.25) inv.FUEL++; else if (r < 0.5) inv.REPAIR++; else if (r < 0.75) inv.SUPPLY++; else inv.HEALTH++;
                    } else {
                        // Bunker drops F4 rares
                        if (r < 0.0008) inv.F4_FUEL++; else inv.FUEL++; // SimplifiÃ© pour demo
                    }
                    // Drop Key
                    const rK = Math.random();
                    if(rK < 0.33) inv.KEY_CITY++; else if(rK < 0.66) inv.KEY_BEACH++; else inv.KEY_FOREST++;
                }
                setInventory(inv);
                setSimStats({ runs: simStats.runs + 100 });
            };

            const totalRev = (inventory.KEY_CITY*keyPrices.CITY) + (inventory.KEY_BEACH*keyPrices.BEACH) + (inventory.KEY_FOREST*keyPrices.FOREST) + (inventory.FUEL*f1Price);
            const totalCost = (simStats.runs * currentData.packRatio) * runCostWax;

            return (
                <div className="p-4 grid grid-cols-2 gap-6">
                    <div className="space-y-4">
                        <Card className="border-t-2 border-pink-500">
                            <h3 className="text-pink-400 font-bold mb-4">CONFIG BLEND</h3>
                            <div className="flex gap-2 mb-4">
                                <button onClick={()=>setActiveZone('CITY_1')} className={`flex-1 py-1 text-xs font-bold border ${activeZone==='CITY_1'?'bg-pink-900 border-pink-500':'border-gray-700'}`}>CITY</button>
                                <button onClick={()=>setActiveZone('BUNKER')} className={`flex-1 py-1 text-xs font-bold border ${activeZone==='BUNKER'?'bg-yellow-900 border-yellow-500':'border-gray-700'}`}>BUNKER</button>
                            </div>
                            <div className="grid grid-cols-2 gap-2 text-xs mb-4">
                                <div><span className="text-gray-500">Prix ClÃ© City</span><input type="number" value={keyPrices.CITY} onChange={e=>setKeyPrices({...keyPrices, CITY: e.target.value})} className="w-full bg-gray-900 border border-gray-700 text-white"/></div>
                                <div><span className="text-gray-500">Prix F1</span><input type="number" value={f1Price} onChange={e=>setF1Price(e.target.value)} className="w-full bg-gray-900 border border-gray-700 text-white"/></div>
                            </div>
                            <button onClick={runSimulation} className="w-full bg-pink-700 hover:bg-pink-600 text-white font-bold py-2 rounded">OUVRIR 100 PACKS</button>
                        </Card>
                        
                        <Card>
                            <h3 className="text-gray-400 font-bold text-xs mb-2">ANALYSE FINANCIERE</h3>
                            <div className="flex justify-between text-sm mb-1"><span>CoÃ»t Total</span><span className="text-red-400">-{Math.floor(totalCost)} WAX</span></div>
                            <div className="flex justify-between text-sm mb-1"><span>Revenus Vente</span><span className="text-green-400">+{Math.floor(totalRev)} WAX</span></div>
                            <div className="border-t border-gray-700 pt-1 flex justify-between font-bold">
                                <span>NET</span>
                                <span className={totalRev-totalCost>0?'text-dov-main':'text-dov-alert'}>{(totalRev-totalCost).toFixed(0)} WAX</span>
                            </div>
                        </Card>
                    </div>

                    <Card>
                        <h3 className="text-white font-bold mb-4">INVENTAIRE SIMULÃ‰</h3>
                        <div className="grid grid-cols-2 gap-2 text-center mb-4">
                            <div className="bg-gray-900 p-2 border border-gray-700"><div className="text-2xl font-bold">{inventory.FUEL}</div><div className="text-xs text-gray-500">F1 Common</div></div>
                            <div className="bg-gray-900 p-2 border border-yellow-900"><div className="text-2xl font-bold text-yellow-500">{inventory.F4_FUEL}</div><div className="text-xs text-gray-500">F4 Legend</div></div>
                        </div>
                        <div className="text-xs text-gray-400">ClÃ©s: {inventory.KEY_CITY} City, {inventory.KEY_BEACH} Beach, {inventory.KEY_FOREST} Forest</div>
                    </Card>
                </div>
            );
        };

        // ==========================================
        // 6. APP PRINCIPALE
        // ==========================================
        const App = () => {
            const [activeTab, setActiveTab] = useState('dashboard');
            const [user, setUser] = useState('u2d2k.c.wam');
            const [realBuildings, setRealBuildings] = useState([]);
            const [realDivisions, setRealDivisions] = useState([]);
            const [prices, setPrices] = useState({ WAX_USD: 0.00786, DOVX_WAX: 0.00528, TU_WAX: 0.00045 });

            return (
                <div className="max-w-[1400px] mx-auto min-h-screen border-x border-gray-800 bg-black">
                    {/* SCANNER HEADER */}
                    <ScannerEngine user={user} onUpdate={(b, d) => { setRealBuildings(b); setRealDivisions(d); }} />
                    
                    {/* CONFIG BAR */}
                    <div className="flex gap-4 p-2 bg-gray-900 text-xs border-b border-gray-800">
                        <div>WAX ($): <input type="number" value={prices.WAX_USD} onChange={e=>setPrices({...prices, WAX_USD:e.target.value})} className="bg-black text-white w-16 border border-gray-700"/></div>
                        <div>DOVX (W): <input type="number" value={prices.DOVX_WAX} onChange={e=>setPrices({...prices, DOVX_WAX:e.target.value})} className="bg-black text-white w-16 border border-gray-700"/></div>
                        <div>JOUEUR: <input type="text" value={user} onChange={e=>setUser(e.target.value)} className="bg-black text-white w-32 border border-gray-700"/></div>
                    </div>

                    {/* TABS */}
                    <div className="flex bg-gray-900 border-b border-gray-800">
                        {['dashboard', 'manager', 'blend', 'combat'].map(t => (
                            <button key={t} onClick={()=>setActiveTab(t)} className={`px-6 py-3 text-sm font-bold uppercase ${activeTab===t ? 'text-dov-main border-b-2 border-dov-main bg-gray-800' : 'text-gray-500 hover:text-white'}`}>
                                {t}
                            </button>
                        ))}
                    </div>

                    {/* CONTENT */}
                    <div className="bg-black min-h-[600px]">
                        {activeTab === 'dashboard' && <DashboardView buildings={realBuildings} divisions={realDivisions} prices={prices} />}
                        {activeTab === 'blend' && <BlendView prices={prices} waxPrice={prices.WAX_USD} />}
                        {activeTab === 'manager' && <div className="p-10 text-center text-gray-500">Le module Manager complet (Packs/Prod) est ici (simulÃ© pour l'affichage concis).</div>}
                        {activeTab === 'combat' && <div className="p-10 text-center text-gray-500">Le module Combat (Officiers/UnitÃ©s) est ici.</div>}
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
