<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DoV COMMANDER v7.0 (ULTIMATE)</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #0f172a; color: #f1f5f9; }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
        .animate-fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        .scan-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 0.5rem; }
    </style>
</head>
<body>

    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        // ==================================================================================
        // 1. DATA LAYER (CONSTANTES & BASES DE DONNÉES)
        // ==================================================================================

        const RPCS = ["https://wax.greymass.com", "https://api.waxsweden.org", "https://wax.eosn.io", "https://api.wax.alohaeos.com", "https://api-wax.eosarabia.net"];
        const INITIAL_PRICES = { WAX: 1, DOVX: 0.005285, DOVR: 0.00045, DOVH: 0.00045, DOVF: 0.00045, DOVS: 0.00045 };

        // --- ICONS ---
        const Icon = ({d, c="text-current", s=20}) => <svg width={s} height={s} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={c}><path d={d}/></svg>;
        const Icons = {
            Shield: () => <Icon d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>,
            Factory: () => <Icon d="M2 20a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V8l-7 5V8l-7 5V4a2 2 0 0 0-2-2H4a2 2 0 0 0-2 2Z"/>,
            Radar: () => <Icon d="M12 2a10 10 0 1 0 10 10 4 4 0 0 1-5-5 6 6 0 1 1-5.32-5.32M22 2l-8.3 8.3M22 2h-4M22 2v4"/>,
            Flask: () => <Icon d="M10 2v7.527a2 2 0 0 1-.211.896L4.72 20.55a1 1 0 0 0 .9 1.45h12.76a1 1 0 0 0 .9-1.45l-5.069-10.127A2 2 0 0 1 14 9.527V2"/>,
            Gift: () => <Icon d="M20 12v10H4V12M2 7h20v5H2zM12 22V7M12 7H7.5a2.5 2.5 0 0 1 0-5C11 2 12 7 12 7zM12 7h4.5a2.5 2.5 0 0 0 0-5C13 2 12 7 12 7z"/>,
            Crosshair: () => <Icon d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z M12 2a10 10 0 1 0 10 10 4 4 0 0 1-5-5 6 6 0 1 1-5.32-5.32"/>, // Simplified
            Scale: () => <Icon d="M16 16l3-8 3 8c-.87.65-1.92 1-3 1s-2.13-.35-3-1zM2 16l3-8 3 8c-.87.65-1.92 1-3 1s-2.13-.35-3-1zM7 21h10M12 3v18M3 7h2c2 0 5-1 7-2 2 1 5 2 7 2h2"/>,
            Users: () => <Icon d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2 M16 3.13a4 4 0 0 1 0 7.75 M23 21v-2a4 4 0 0 0-3-3.87"/>,
            Key: () => <Icon d="M21 2l-2 2m-7.6 7.6a6.5 6.5 0 1 1-5.3 5.3L3 21l3-3 2.1-2.1a2 2 0 0 1 2.8 0L13.4 13.4a2 2 0 0 1 0 2.8l-4.3 4.3"/>
        };

        // --- ZONE DB (UNIFIÉE) ---
        const MASTER_ZONES_DB = [
            { id: 1, name: 'Beach 1', type: 'Beach', reward: 400, cost: 1160, costX: 0, minWeight: 14, officerReq: 1, keyReq: 0 },
            { id: 2, name: 'Beach 2', type: 'Beach', reward: 2405, cost: 6968, costX: 0, minWeight: 28, officerReq: 2, keyReq: 5 },
            { id: 3, name: 'Beach 3', type: 'Beach', reward: 3037, cost: 8800, costX: 0, minWeight: 55, officerReq: 3, keyReq: 6 },
            { id: 4, name: 'Bunker',  type: 'Beach', reward: 3838, cost: 11120, costX: 0, minWeight: 109, officerReq: 4, keyReq: 7, isCheckpoint: true, unitReq: 'e2' }, 
            { id: 5, name: 'Forest 1', type: 'Forest', reward: 4840, cost: 14024, costX: 0, minWeight: 219, officerReq: 5, keyReq: 8 },
            { id: 6, name: 'Forest 2', type: 'Forest', reward: 6110, cost: 17704, costX: 0, minWeight: 342, officerReq: 6, keyReq: 9 },
            { id: 7, name: 'Forest 3', type: 'Forest', reward: 7714, cost: 22352, costX: 0, minWeight: 450, officerReq: 7, keyReq: 10 },
            { id: 8, name: 'Camp',     type: 'Forest', reward: 9739, cost: 28220, costX: 0, minWeight: 512, officerReq: 8, keyReq: 11, isCheckpoint: true, unitReq: 'e1' }, 
            { id: 9,  name: 'Hill 1', type: 'Hill', reward: 12788, cost: 37052, costX: 0, minWeight: 695, officerReq: 9, keyReq: 12 },
            { id: 10, name: 'Hill 2', type: 'Hill', reward: 16791, cost: 48652, costX: 0, minWeight: 869, officerReq: 10, keyReq: 13 },
            { id: 11, name: 'Hill 3', type: 'Hill', reward: 22266, cost: 64516, costX: 0, minWeight: 1086, officerReq: 11, keyReq: 14 },
            { id: 12, name: 'Radar',  type: 'Hill', reward: 29236, cost: 84712, costX: 0, minWeight: 1358, officerReq: 12, keyReq: 15, isCheckpoint: true, unitReq: 'e3', godmotherReq: true },
            { id: 13, name: 'Plain 1', type: 'Plain', reward: 34300, cost: 99384, costX: 0, minWeight: 1697, officerReq: 13, keyReq: 16 },
            { id: 14, name: 'Plain 2', type: 'Plain', reward: 43385, cost: 125708, costX: 0, minWeight: 1866, officerReq: 14, keyReq: 17 },
            { id: 15, name: 'Plain 3', type: 'Plain', reward: 52171, cost: 151164, costX: 0, minWeight: 2052, officerReq: 15, keyReq: 18 },
            { id: 16, name: 'HQ',      type: 'Plain', reward: 64884, cost: 188000, costX: 0, minWeight: 2495, officerReq: 16, keyReq: 19, isCheckpoint: true, unitReq: 'l1', godmotherReq: true },
            { id: 17, name: 'City 1', type: 'City', reward: 0, cost: 0, costX: 1664, minWeight: 108.5, officerReq: 1, keyReq: 9 },
            { id: 18, name: 'City 2', type: 'City', reward: 0, cost: 0, costX: 4448, minWeight: 511.7, officerReq: 1, keyReq: 13 },
            { id: 19, name: 'City 3', type: 'City', reward: 0, cost: 0, costX: 13440, minWeight: 1357, officerReq: 1, keyReq: 17 },
            { id: 20, name: 'City 4', type: 'City', reward: 0, cost: 0, costX: 29120, minWeight: 2494, officerReq: 1, keyReq: 20 }
        ];

        // --- TACTICAL DATABASE (Unités/Officiers/Clés du Fichier 28) ---
        const ALL_OFFICERS = Array.from({length: 20}, (_, i) => ({ id: `o${i+1}`, name: `Officier Lvl ${i+1}`, order: i+1 }));
        const ALL_KEYS = Array.from({length: 20}, (_, i) => ({ id: `k${i+1}`, name: `Clé Tactique Lvl ${i+1}`, order: i+1 }));
        const ALL_GODMOTHERS = [{ id: 'gm1', name: 'Sonja Henie' }, { id: 'gm2', name: 'Miss Betty' }];
        const ALL_SUPPORTS = [
            { id: 's1', name: 'Medical Bn (0.5%)', bonusPct: 0.5 }, { id: 's2', name: 'Signal Bn (1.5%)', bonusPct: 1.5 },
            { id: 's3', name: 'Medical 104th (2.5%)', bonusPct: 2.5 }, { id: 's4', name: 'Kiyo Spec (12%)', bonusPct: 12.0 }
        ];
        
        const UNIT_TEMPLATES = [
            { baseId: 'c1', name: 'Infantry', type: 'Infantry', rarity: 'Common', base: 0.3, b: { Beach: 1.0, Plain: 0.22, Forest: 1.0, Hill: 0.72, City: 0.01 } },
            { baseId: 'c4', name: 'Artillery', type: 'Artillery', rarity: 'Common', base: 0.3, b: { Beach: 1.0, Plain: 1.0, Forest: 0.72, Hill: 1.0, City: 0.01 } },
            { baseId: 'r1', name: 'Elite Inf', type: 'Infantry', rarity: 'Rare', base: 3.6, b: { Beach: 1.0, Plain: 0.22, Forest: 1.0, Hill: 1.0, City: 0.01 } },
            { baseId: 'e3', name: 'Heavy Tank', type: 'Tank', rarity: 'Epic', base: 8.42, b: { Beach: 0.22, Plain: 1.0, Forest: 0.22, Hill: 0.72, City: 0.01 } },
            { baseId: 'l1', name: 'Legend Tank', type: 'Tank', rarity: 'Legendary', base: 57.6, b: { Beach: 0.22, Plain: 1.0, Forest: 0.22, Hill: 0.72, City: 0.01 } },
        ];
        // Génération des unités F1-F4
        const ALL_UNITS = [];
        UNIT_TEMPLATES.forEach(tpl => {
            for (let l = 1; l <= 4; l++) {
                ALL_UNITS.push({ 
                    id: `${tpl.baseId}_f${l}`, name: `F${l} ${tpl.name}`, type: tpl.type, 
                    rarity: tpl.rarity, baseWeight: tpl.base * Math.pow(3, l-1), bonuses: tpl.b 
                });
            }
        });

        // Inventaire Mock pour le module Combat
        const MOCK_INVENTORY = { keys: ALL_KEYS, officers: ALL_OFFICERS, supports: ALL_SUPPORTS, godmothers: ALL_GODMOTHERS, units: ALL_UNITS };

        const Card = ({ children, className = "" }) => <div className={`bg-slate-800 border border-slate-700 rounded-lg p-4 shadow-xl ${className}`}>{children}</div>;

        // ==================================================================================
        // 2. MODULES (Scanner, Combat, Blend)
        // ==================================================================================

        // --- MODULE SCANNER (PHASE 2) ---
        const LiveScanner = ({ targetUser, onUpdate }) => {
            const [scanning, setScanning] = useState(false);
            const [logs, setLogs] = useState([]);
            const [scanStats, setScanStats] = useState({ total: 0, ready: 0, busy: 0, F:0, H:0, R:0, S:0 });
            const [buildingsList, setBuildingsList] = useState([]);

            const addLog = (msg) => setLogs(prev => [`> ${msg}`, ...prev].slice(0, 5));

            const fetchTable = async (code, table, lower) => {
                let attempts = 0;
                while(attempts < 3) {
                    try {
                        const rpc = RPCS[Math.floor(Math.random() * RPCS.length)];
                        const res = await fetch(`${rpc}/v1/chain/get_table_rows`, {
                            method: 'POST', body: JSON.stringify({ json: true, code, scope: code, table, limit: 1000, lower_bound: lower })
                        });
                        if(res.ok) return await res.json();
                    } catch(e) {}
                    attempts++;
                }
                return { rows: [] };
            };

            const startScan = async () => {
                setScanning(true); setBuildingsList([]); setLogs([]);
                addLog(`Scan de ${targetUser}...`);
                let allBuildings = [];
                let nextKey = "";
                let hasMore = true;
                let c = { total: 0, ready: 0, busy: 0, F:0, H:0, R:0, S:0 };

                try {
                    while(hasMore) {
                        const data = await fetchTable("dovutilstake", "buildings", nextKey);
                        if(!data.rows || !data.rows.length) break;
                        const batch = data.rows.filter(r => r.owner === targetUser);
                        const now = Date.now()/1000;
                        batch.forEach(b => {
                            c.total++;
                            const isReady = now > (parseFloat(b.last_claim) + parseFloat(b.delay));
                            if(isReady) c.ready++; else c.busy++;
                            const pRaw = Array.isArray(b.power) ? b.power[0] : b.power;
                            if(pRaw.includes("DOVF")) c.F++; else if(pRaw.includes("DOVH")) c.H++;
                            else if(pRaw.includes("DOVR")) c.R++; else if(pRaw.includes("DOVS")) c.S++;
                            allBuildings.push({ ...b, isReady, pRaw });
                        });
                        setScanStats({...c});
                        setBuildingsList(prev => [...prev, ...batch.map(b => {
                             const now = Date.now()/1000;
                             return { ...b, isReady: now > (parseFloat(b.last_claim) + parseFloat(b.delay)), pRaw: Array.isArray(b.power) ? b.power[0] : b.power };
                        })]);
                        if(data.more && data.next_key !== nextKey) nextKey = data.next_key; else hasMore = false;
                        addLog(`Batch: ${batch.length} bâtiments.`);
                    }
                    // Scan Divisions
                    addLog("Récupération divisions...");
                    const divData = await fetchTable("dovpvecontrl", "sdivisions", targetUser);
                    const divs = divData.rows ? divData.rows.filter(r => r.owner === targetUser || r.user === targetUser) : [];
                    onUpdate(allBuildings, divs);
                    addLog(`Terminé! ${c.total} Bâtiments, ${divs.length} Divs.`);
                } catch(e) { addLog("Erreur: " + e.message); }
                setScanning(false);
            };

            return (
                <div className="space-y-4 mb-6">
                    <Card className="border-l-4 border-purple-500">
                        <div className="flex justify-between items-center mb-4">
                            <h3 className="font-bold text-purple-400 flex items-center gap-2"><Icons.Radar/> SCANNER LIVE</h3>
                            <button onClick={startScan} disabled={scanning} className={`px-6 py-2 rounded font-bold ${scanning?'bg-slate-700':'bg-purple-600 hover:bg-purple-500'}`}>
                                {scanning ? 'SCAN EN COURS...' : 'LANCER SCAN'}
                            </button>
                        </div>
                        <div className="grid grid-cols-4 gap-2 text-center text-xs">
                            <div className="bg-slate-900 p-2 rounded"><div className="text-slate-400">TOTAL</div><div className="text-lg font-bold">{scanStats.total}</div></div>
                            <div className="bg-slate-900 p-2 rounded border border-emerald-500/30"><div className="text-emerald-400">PRÊTS</div><div className="text-lg font-bold text-emerald-400">{scanStats.ready}</div></div>
                            <div className="bg-slate-900 p-2 rounded border border-orange-500/30"><div className="text-orange-400">ACTIFS</div><div className="text-lg font-bold text-orange-400">{scanStats.busy}</div></div>
                            <div className="bg-slate-900 p-2 rounded flex flex-col justify-center">
                                <div className="flex justify-between"><span className="text-orange-300">F:{scanStats.F}</span><span className="text-red-300">H:{scanStats.H}</span></div>
                                <div className="flex justify-between"><span className="text-slate-300">R:{scanStats.R}</span><span className="text-yellow-300">S:{scanStats.S}</span></div>
                            </div>
                        </div>
                        <div className="mt-4 bg-black p-2 rounded font-mono text-[10px] text-slate-500 h-16 overflow-y-auto">
                            {logs.map((l, i) => <div key={i}>{l}</div>)}
                        </div>
                    </Card>
                </div>
            );
        };

        // --- MODULE COMBAT (PHASE 4 - Adapté du Fichier 28) ---
        const CombatModule = ({ waxPrice }) => {
            const [zoneId, setZoneId] = useState(1);
            const [squad, setSquad] = useState([]);
            const [officer, setOfficer] = useState(null);
            
            const zone = MASTER_ZONES_DB.find(z => z.id === parseInt(zoneId));
            
            const stats = useMemo(() => {
                let weight = 0;
                squad.forEach(u => {
                    const bonus = u.bonuses[zone.type] || 1.0;
                    weight += u.baseWeight * bonus;
                });
                return { weight };
            }, [squad, zone]);

            const toggleUnit = (u) => {
                if(squad.find(i=>i.id===u.id)) setSquad(squad.filter(i=>i.id!==u.id));
                else if(squad.length < 10) setSquad([...squad, u]);
            };

            return (
                <div className="grid grid-cols-1 lg:grid-cols-3 gap-6 animate-fade-in">
                    <div className="lg:col-span-1 space-y-4">
                        <Card>
                            <h3 className="font-bold text-blue-400 mb-2">1. Cible</h3>
                            <select className="w-full bg-slate-900 border border-slate-600 rounded p-2 text-sm" value={zoneId} onChange={e=>setZoneId(e.target.value)}>
                                {MASTER_ZONES_DB.map(z => <option key={z.id} value={z.id}>{z.name} (Min: {z.minWeight})</option>)}
                            </select>
                            <div className="mt-4 text-xs text-slate-400">
                                <div className="flex justify-between"><span>Win:</span> <span className="text-emerald-400">{zone.reward} DOVX</span></div>
                                <div className="flex justify-between"><span>Coût:</span> <span className="text-red-400">{zone.cost > 0 ? zone.cost/4 + ' TU x4' : zone.costX + ' DOVX'}</span></div>
                            </div>
                        </Card>
                        <Card>
                            <h3 className="font-bold text-yellow-400 mb-2">2. État Major</h3>
                            <select className="w-full bg-slate-900 border border-slate-600 rounded p-2 text-sm mb-2" onChange={e=>setOfficer(MOCK_INVENTORY.officers.find(o=>o.id===e.target.value))}>
                                <option>-- Officier --</option>
                                {MOCK_INVENTORY.officers.map(o=><option key={o.id} value={o.id}>{o.name}</option>)}
                            </select>
                            <div className={`text-xs p-2 rounded border ${officer && officer.order >= zone.officerReq ? 'bg-green-900/30 border-green-500 text-green-400' : 'bg-red-900/30 border-red-500 text-red-400'}`}>
                                Requis: Officier Lvl {zone.officerReq}
                            </div>
                        </Card>
                    </div>
                    <div className="lg:col-span-2">
                        <Card className="h-full">
                            <div className="flex justify-between items-center mb-4">
                                <h3 className="font-bold text-white">3. Escouade ({squad.length}/10)</h3>
                                <div className={`px-3 py-1 rounded text-sm font-bold ${stats.weight >= zone.minWeight ? 'bg-emerald-600' : 'bg-red-600'}`}>
                                    Puissance: {stats.weight.toFixed(1)} / {zone.minWeight}
                                </div>
                            </div>
                            <div className="grid grid-cols-2 sm:grid-cols-3 gap-2 max-h-[400px] overflow-y-auto pr-2">
                                {MOCK_INVENTORY.units.map(u => {
                                    const selected = squad.find(i=>i.id===u.id);
                                    const bonus = u.bonuses[zone.type] || 0;
                                    const eff = u.baseWeight * bonus;
                                    return (
                                        <div key={u.id} onClick={()=>toggleUnit(u)} className={`p-2 rounded border cursor-pointer text-xs ${selected?'bg-blue-900/40 border-blue-500':'bg-slate-900 border-slate-700'}`}>
                                            <div className="font-bold text-white">{u.name}</div>
                                            <div className="flex justify-between mt-1 text-slate-400">
                                                <span>{u.rarity}</span>
                                                <span className={bonus>=1?'text-emerald-400':'text-red-400'}>{eff.toFixed(1)}</span>
                                            </div>
                                        </div>
                                    )
                                })}
                            </div>
                        </Card>
                    </div>
                </div>
            );
        };

        // --- MODULE BLEND (PHASE 4 - Adapté du Fichier 29) ---
        const BlendModule = () => {
            const [mode, setMode] = useState('CITY');
            const [res, setRes] = useState({ f1:0, f4:0 });
            
            const sim = () => {
                let f1=0, f4=0;
                for(let i=0;i<100;i++) {
                    if(mode==='CITY') f1++;
                    else Math.random() < 0.0008 ? f4++ : f1++;
                }
                setRes({f1: res.f1+f1, f4: res.f4+f4});
            };

            return (
                <Card className="border-t-4 border-pink-500 animate-fade-in">
                    <h3 className="font-bold text-pink-400 mb-4 flex items-center gap-2"><Icons.Flask/> SIMULATEUR DE BLEND</h3>
                    <div className="flex gap-4 mb-6">
                        <button onClick={()=>setMode('CITY')} className={`flex-1 py-3 rounded font-bold ${mode==='CITY'?'bg-pink-600':'bg-slate-700'}`}>CITY (100% F1)</button>
                        <button onClick={()=>setMode('BUNKER')} className={`flex-1 py-3 rounded font-bold ${mode==='BUNKER'?'bg-yellow-600':'bg-slate-700'}`}>BUNKER (Chance F4)</button>
                    </div>
                    <div className="grid grid-cols-2 gap-4 text-center mb-6">
                        <div className="bg-slate-900 p-4 rounded border border-slate-700">
                            <div className="text-3xl font-bold text-white">{res.f1}</div>
                            <div className="text-sm text-slate-500">Communs (F1)</div>
                        </div>
                        <div className="bg-slate-900 p-4 rounded border border-yellow-700/30">
                            <div className="text-3xl font-bold text-yellow-400">{res.f4}</div>
                            <div className="text-sm text-yellow-600">Légendaires (F4)</div>
                        </div>
                    </div>
                    <button onClick={sim} className="w-full py-3 bg-pink-700 hover:bg-pink-600 rounded font-bold text-white shadow-lg">OUVRIR 100 PACKS</button>
                </Card>
            );
        };

        // ==================================================================================
        // 3. APP PRINCIPALE (INTEGRATION TOTALE)
        // ==================================================================================

        const App = () => {
            const [tab, setTab] = useState('manager');
            const [user, setUser] = useState('u2d2k.c.wam');
            const [waxPrice, setWaxPrice] = useState(0.008);
            const [prices, setPrices] = useState(INITIAL_PRICES);
            
            // DONNÉES LIVE
            const [myBuildings, setMyBuildings] = useState([]);
            const [myDivisions, setMyDivisions] = useState([]);

            // CALCULS FINANCIERS (PHASE 3)
            const stats = useMemo(() => {
                let prod = 0, cost = 0, reward = 0;
                const now = Date.now()/1000;
                myBuildings.forEach(b => {
                    const val = parseFloat(b.pRaw.replace(/[^0-9.]/g, '')) || 0;
                    prod += val * prices.DOVF; // Simplification TU
                    cost += (val * 0.1) * prices.DOVX;
                });
                myDivisions.forEach(d => {
                    const z = MASTER_ZONES_DB.find(zone => zone.id === d.zoneId);
                    if(z && d.endTime > now) {
                        reward += z.reward * prices.DOVX;
                        cost += z.costX > 0 ? (z.costX * prices.DOVX) : (z.cost * prices.DOVF);
                    }
                });
                const net = (prod + reward) - cost;
                return { prod, cost, reward, net, netUSD: net * waxPrice };
            }, [myBuildings, myDivisions, waxPrice]);

            return (
                <div className="max-w-[1600px] mx-auto p-4 min-h-screen text-slate-200">
                    {/* HEADER */}
                    <div className="flex flex-col md:flex-row justify-between items-center mb-6 border-b border-slate-700 pb-4 gap-4">
                        <div className="flex items-center gap-3">
                            <div className="bg-blue-600 p-2 rounded"><Icons.Shield/></div>
                            <div>
                                <h1 className="text-2xl font-bold text-white tracking-wider">DoV <span className="text-blue-400">COMMANDER</span> v7.0</h1>
                                <p className="text-slate-400 text-xs">Full Suite : Manager + Scanner + Combat + Blend</p>
                            </div>
                        </div>
                        <div className="flex gap-4 bg-slate-800 p-2 rounded text-sm items-center">
                            <div><span className="text-[10px] text-green-400 block font-bold">WAX ($)</span><input type="number" value={waxPrice} onChange={e=>setWaxPrice(e.target.value)} className="w-20 bg-slate-900 border border-slate-600 rounded px-2"/></div>
                            <div><span className="text-[10px] text-slate-400 block">JOUEUR</span><input value={user} onChange={e=>setUser(e.target.value)} className="w-32 bg-slate-900 border border-slate-600 rounded px-2"/></div>
                        </div>
                    </div>

                    {/* SCANNER ALWAYS ON TOP */}
                    <LiveScanner targetUser={user} onUpdate={(b, d) => { setMyBuildings(b); setMyDivisions(d); }} />

                    {/* NAVIGATION TABS */}
                    <div className="flex gap-2 mb-6 overflow-x-auto pb-2">
                        <button onClick={()=>setTab('manager')} className={`px-4 py-2 rounded font-bold flex gap-2 ${tab==='manager'?'bg-blue-600 text-white':'bg-slate-800 text-slate-400'}`}><Icons.Factory/> MANAGER</button>
                        <button onClick={()=>setTab('combat')} className={`px-4 py-2 rounded font-bold flex gap-2 ${tab==='combat'?'bg-emerald-600 text-white':'bg-slate-800 text-slate-400'}`}><Icons.Crosshair/> COMBAT</button>
                        <button onClick={()=>setTab('blend')} className={`px-4 py-2 rounded font-bold flex gap-2 ${tab==='blend'?'bg-pink-600 text-white':'bg-slate-800 text-slate-400'}`}><Icons.Flask/> BLEND</button>
                        <button onClick={()=>setTab('assets')} className={`px-4 py-2 rounded font-bold flex gap-2 ${tab==='assets'?'bg-cyan-600 text-white':'bg-slate-800 text-slate-400'}`}><Icons.Scale/> ASSETS</button>
                    </div>

                    {/* TAB: MANAGER */}
                    {tab === 'manager' && (
                        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 animate-fade-in">
                            <Card className="border-t-4 border-emerald-500">
                                <h3 className="text-lg font-bold text-white mb-4">Flux Financier (Réel)</h3>
                                <div className="space-y-3 text-sm">
                                    <div className="flex justify-between border-b border-slate-700 pb-2"><span>Production Usines</span><span className="text-emerald-400">+{stats.prod.toFixed(2)} W</span></div>
                                    <div className="flex justify-between border-b border-slate-700 pb-2"><span>Gains Combats</span><span className="text-emerald-400">+{stats.reward.toFixed(2)} W</span></div>
                                    <div className="flex justify-between border-b border-slate-700 pb-2"><span>Coûts</span><span className="text-red-400">-{stats.cost.toFixed(2)} W</span></div>
                                    <div className="bg-slate-900 p-4 rounded text-center mt-4">
                                        <div className="text-xs text-slate-500 uppercase">Cashflow Net / Jour</div>
                                        <div className={`text-3xl font-bold font-mono ${stats.net>0?'text-blue-400':'text-red-500'}`}>{stats.net>0?'+':''}{stats.net.toFixed(2)} WAX</div>
                                        <div className="text-sm text-emerald-500">≈ ${stats.netUSD.toFixed(2)}</div>
                                    </div>
                                </div>
                            </Card>
                            <Card>
                                <h3 className="text-lg font-bold text-orange-400 mb-4">Divisions Actives</h3>
                                <div className="h-64 overflow-y-auto pr-2 space-y-2">
                                    {myDivisions.length === 0 && <div className="text-center text-slate-500 italic">Aucune division.</div>}
                                    {myDivisions.map((d, i) => {
                                        const z = MASTER_ZONES_DB.find(zone => zone.id === d.zoneId);
                                        const isBusy = d.endTime > Date.now()/1000;
                                        return (
                                            <div key={i} className="bg-slate-900 p-2 rounded flex justify-between text-xs border border-slate-700">
                                                <div><div className="font-bold text-white">{z?z.name:'Zone '+d.zoneId}</div><div className="text-slate-500">#{d.id}</div></div>
                                                <div className="text-right">{isBusy ? <span className="text-orange-400 font-bold">MISSION</span> : <span className="text-emerald-400 font-bold">PRÊT</span>}</div>
                                            </div>
                                        );
                                    })}
                                </div>
                            </Card>
                        </div>
                    )}

                    {/* TAB: COMBAT */}
                    {tab === 'combat' && <CombatModule waxPrice={waxPrice} />}

                    {/* TAB: BLEND */}
                    {tab === 'blend' && <BlendModule />}

                    {/* TAB: ASSETS */}
                    {tab === 'assets' && (
                        <div className="animate-fade-in">
                            <h3 className="text-lg font-bold text-white mb-4">Inventaire ({myBuildings.length})</h3>
                            <div className="scan-grid">
                                {myBuildings.map((b, i) => (
                                    <div key={i} className={`p-2 rounded border text-xs ${b.isReady?'bg-emerald-900/20 border-emerald-800':'bg-slate-800 border-slate-700'}`}>
                                        <div className="flex justify-between mb-1"><span className="text-slate-500">#{b.asset_id}</span><span className={b.isReady?'text-emerald-400 font-bold':'text-orange-400'}>{b.isReady?'CLAIM':'BUSY'}</span></div>
                                        <div className="font-mono font-bold text-white">{b.pRaw}</div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
